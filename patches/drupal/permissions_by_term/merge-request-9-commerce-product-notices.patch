From bb5e120f2144cf15986eb1d84a5dca16b176ea5d Mon Sep 17 00:00:00 2001
From: Matei Stanca <i@ambientimpact.com>
Date: Sat, 4 Sep 2021 09:50:03 -0400
Subject: [PATCH] Permissions by Entity: fix PHP notices when ->entity not set.

E.g. Commerce Product entities.
---
 .../src/Service/AccessChecker.php             | 20 +++++++++----------
 1 file changed, 10 insertions(+), 10 deletions(-)

diff --git a/modules/permissions_by_entity/src/Service/AccessChecker.php b/modules/permissions_by_entity/src/Service/AccessChecker.php
index 021d1f3..2faa397 100644
--- a/modules/permissions_by_entity/src/Service/AccessChecker.php
+++ b/modules/permissions_by_entity/src/Service/AccessChecker.php
@@ -82,7 +82,7 @@ class AccessChecker extends AccessCheck implements AccessCheckerInterface {
 
       // Check if the field contains another fieldable entity,
       // that we need to check.
-      if ($field->entity && $field->entity instanceof FieldableEntityInterface) {
+      if (isset($field->entity) && $field->entity instanceof FieldableEntityInterface) {
 
         // We need to iterate over the entities.
         $num_values = $field->count();
@@ -100,15 +100,15 @@ class AccessChecker extends AccessCheck implements AccessCheckerInterface {
               continue;
             }
 
-            // Get the field entity.
-            $field_entity = $field_value->entity;
-
             // If the field entity is null we also continue with the next index
             // of the loop.
-            if (!$field_entity) {
+            if (!isset($field_value->entity)) {
               continue;
             }
 
+            // Get the field entity.
+            $field_entity = $field_value->entity;
+
             // It is possible, that the referenced field entity creates a
             // circular dependency to the current entity. This will cause
             // memory limit exhausted errors because there is no way out for
@@ -179,7 +179,7 @@ class AccessChecker extends AccessCheck implements AccessCheckerInterface {
 
       // Check if the field contains another fieldable entity,
       // that we need to check.
-      if ($field->entity && $field->entity instanceof FieldableEntityInterface) {
+      if (isset($field->entity) && $field->entity instanceof FieldableEntityInterface) {
 
         // We need to iterate over the entities.
         $num_values = $field->count();
@@ -197,15 +197,15 @@ class AccessChecker extends AccessCheck implements AccessCheckerInterface {
               continue;
             }
 
-            // Get the field entity.
-            $field_entity = $field_value->entity;
-
             // If the field entity is null we also continue with the next index
             // of the loop.
-            if (!$field_entity) {
+            if (!isset($field_value->entity)) {
               continue;
             }
 
+            // Get the field entity.
+            $field_entity = $field_value->entity;
+
             // It is possible, that the referenced field entity creates a
             // circular dependency to the current entity. This will cause
             // memory limit exhausted errors because there is no way out for
-- 
GitLab

